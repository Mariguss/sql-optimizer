<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ó–∞–ø—Ä–æ—Å–æ–≤</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 20px; 
            background-color: #f4f7f9;
            color: #333;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            margin-top: 30px;
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #2c3e50;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }
        textarea {
            font-family: "Courier New", Courier, monospace;
            min-height: 150px;
            resize: vertical;
        }
        .buttons-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:hover { 
            background-color: #2980b9; 
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary { background-color: #95a5a6; }
        button.secondary:hover { background-color: #7f8c8d; }
        button.danger { background-color: #e74c3c; }
        button.danger:hover { background-color: #c0392b; }
        button.success { background-color: #2ecc71; }
        button.success:hover { background-color: #27ae60; }

        #result {
            margin-top: 20px;
            padding: 20px;
            background-color: #2c3e50;
            color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Courier New", Courier, monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        .connection-status {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
        .connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading, .error, .success { padding: 15px; border-radius: 5px; }
        .loading { color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }

        .plan-node {

margin-left: 20px;
            padding-left: 15px;
            border-left: 2px solid #3498db;
            margin-top: 10px;
        }
        .plan-info { font-weight: bold; color: #ecf0f1; }
        .plan-cost { color: #e74c3c; }
        .plan-time { color: #2ecc71; }
        .plan-details ul { padding-left: 20px; margin: 5px 0; color: #bdc3c7;}
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç SQL –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ó–∞–ø—Ä–æ—Å–æ–≤</h1>
        
        <div id="connectionStatus" class="connection-status disconnected">
            ‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        </div>

        <h2>üì° –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
        <div class="form-grid">
            <div>
                <label for="db_host">–•–æ—Å—Ç:</label>
                <input type="text" id="db_host" name="db_host" placeholder="localhost" required>
            </div>
            <div>
                <label for="db_port">–ü–æ—Ä—Ç:</label>
                <input type="text" id="db_port" name="db_port" value="5432" required>
            </div>
            <div>
                <label for="db_user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
                <input type="text" id="db_user" name="db_user" placeholder="postgres" required>
            </div>
            <div>
                <label for="db_password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="db_password" name="db_password" required>
            </div>
            <div>
                <label for="db_name">–ò–º—è –ë–î:</label>
                <input type="text" id="db_name" name="db_name" placeholder="postgres" required>
            </div>
        </div>
        <div class="buttons-group">
            <button type="button" onclick="connectToDatabase()" class="success">üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" onclick="disconnectFromDatabase()" class="danger">‚ùå –ó–∞–±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        </div>

        <h2>üìù SQL –ó–∞–ø—Ä–æ—Å –¥–ª—è –ê–Ω–∞–ª–∏–∑–∞</h2>
        <textarea id="sql_query" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à SQL –∑–∞–ø—Ä–æ—Å –∑–¥–µ—Å—å..."></textarea>
        <div class="buttons-group">
            <button type="button" onclick="analyzeQuery()">‚ö° –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ó–∞–ø—Ä–æ—Å</button>
            <button type="button" onclick="clearQuery()" class="secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button type="button" onclick="loadExampleQuery()" class="secondary">üìã –ü—Ä–∏–º–µ—Ä</button>
        </div>

        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ê–Ω–∞–ª–∏–∑–∞</h2>
        <div id="result">
            <p style="color: #bdc3c7">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–≥–æ SQL –∑–∞–ø—Ä–æ—Å–∞.</p>
        </div>
    </div>

    <script>
        let dbConnected = false;
        let dbParams = {};

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–ª–æ–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const showMessage = (type, message) => {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="${type}">${message}</div>`;
        };

        const updateConnectionStatus = () => {
            const statusDiv = document.getElementById('connectionStatus');
            if (dbConnected) {
                statusDiv.className = 'connection-status connected';
                statusDiv.innerHTML = `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ <strong>${dbParams.db_user}@${dbParams.db_host}/${dbParams.db_name}</strong>`;
            } else {
                statusDiv.className = 'connection-status disconnected';
                statusDiv.innerHTML = '‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';
            }
        };

        const connectToDatabase = async () => {
            const currentParams = {
                db_host: document.getElementById('db_host').value.trim(),
                db_port: document.getElementById('db_port').value.trim(),
                db_user: document.getElementById('db_user').value.trim(),
                db_password: document.getElementById('db_password').value.trim(),
                db_name: document.getElementById('db_name').value.trim()
            };

            if (!currentParams.db_host || !currentParams.db_port || !currentParams.db_user || !currentParams.db_name) {
                showMessage('error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!');
                return;
            }

            showMessage('loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');

            try {
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentParams)
                });

                if (response.ok) {
                    const data = await response.json();
                    dbParams = currentParams; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                    dbConnected = true;
                    showMessage('success', data.message || '–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!');
                } else {
                    const errorText = await response.text();
                    dbConnected = false;
                    showMessage('error', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${errorText}`);
                }
            } catch (error) {
                dbConnected = false;
                showMessage('error', `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
            }
            updateConnectionStatus();
        };

        const disconnectFromDatabase = () => {
            dbConnected = false;
            dbParams = {};
            showMessage('success', '–î–∞–Ω–Ω—ã–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∑–∞–±—ã—Ç—ã.');
            updateConnectionStatus();
        };

        const analyzeQuery = async () => {
            if (!dbConnected) {
                showMessage('error', '–°–Ω–∞—á–∞–ª–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!');
                return;
            }

            const sqlQuery = document.getElementById('sql_query').value.trim();
            if (!sqlQuery) {
                showMessage('error', '–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞!');
                return;
            }

            showMessage('loading', '–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: sqlQuery, ...dbParams })
                });

                if (response.ok) {
                    const planData = await response.json();
                    displayQueryPlan(planData);
                } else {
                    const errorText = await response.text();
                    showMessage('error', `–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${errorText}`);
                }
            } catch (error) {
                showMessage('error', `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
            }
        };

        const displayQueryPlan = (analysisResult) => {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = ''; // Clear previous content

    if (analysisResult.total_cost === undefined) {
        showMessage('error', '–ü–æ–ª—É—á–µ–Ω –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞.');
        return;
    }

    // Display basic analysis info
    let summaryHtml = `
        <h3>–°–≤–æ–¥–∫–∞</h3>
        <p><strong>–û–±—â–∞—è –°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${analysisResult.total_cost.toFixed(2)}</p>
        ${analysisResult.total_actual_time ? `<p><strong>–û–±—â–µ–µ –í—Ä–µ–º—è (ms):</strong> ${analysisResult.total_actual_time.toFixed(2)}</p>` : ''}
    `;

    // Display warnings
    if (analysisResult.warnings && analysisResult.warnings.length > 0) {
        summaryHtml += `
            <div class="error">
                <h3>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</h3>
                <ul>${analysisResult.warnings.map(warn => `<li>${warn}</li>`).join('')}</ul>
            </div>
        `;
    }

    // Display problematic operations
    if (analysisResult.problematic_operations && analysisResult.problematic_operations.length > 0) {
        summaryHtml += `
            <div class="error">
                <h3>üö® –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                <ul>${analysisResult.problematic_operations.map(op => `<li><strong>${op.node_type}</strong>: ${op.description} (–°—Ç–æ–∏–º–æ—Å—Ç—å: ${op.cost.toFixed(2)})</li>`).join('')}</ul>
            </div>
        `;
    }

    // Display recommendations
    if (analysisResult.recommendations && analysisResult.recommendations.length > 0) {
        summaryHtml += `
            <div class="success">
                <h3>‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h3>
                <ul>${analysisResult.recommendations.map(rec => `<li>${rec}</li>`).join('')}</ul>
            </div>
        `;
    }

    resultDiv.innerHTML = summaryHtml;
};

        const renderPlanNode = (node, depth) => {
            let html = `<div class="plan-node" style="margin-left: ${depth * 25}px;">
                <div class="plan-info"><strong>${node['Node Type']}</strong></div>`;

            if (node['Relation Name']) html += `<div>–¢–∞–±–ª–∏—Ü–∞: ${node['Relation Name']}</div>`;
            if (node['Total Cost']) html += `<div class="plan-cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${node['Total Cost']}</div>`;
            
            const details = Object.entries(node).filter(([key]) => 
                !['Plans', 'Node Type', 'Relation Name', 'Total Cost'].includes(key) && typeof node[key] !== 'object'
            ).map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`).join('');

            if (details) html += `<div class="plan-details"><ul>${details}</ul></div>`;

            if (node.Plans && node.Plans.length > 0) {
                node.Plans.forEach(child => {
                    html += renderPlanNode(child, depth + 1);

});
            }
            
            html += `</div>`;
            return html;
        };

        const clearQuery = () => {
            document.getElementById('sql_query').value = '';
            showMessage('success', '–ü–æ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –æ—á–∏—â–µ–Ω–æ.');
        };
        
        const loadExampleQuery = () => {
            document.getElementById('sql_query').value = `SELECT * FROM pg_class, pg_namespace\nWHERE pg_class.relnamespace = pg_namespace.oid AND nspname = 'pg_catalog';`;
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            updateConnectionStatus();
            loadExampleQuery();
             // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('db_host').value = 'localhost';
            document.getElementById('db_user').value = 'postgres';
            document.getElementById('db_name').value = 'postgres';
        };
    </script>
</body>
</html>